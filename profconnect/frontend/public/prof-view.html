<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Professor Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ProfConnect</a>
      <div class="d-flex align-items-center">
        <span id="welcome" class="me-3 text-muted small"></span>
        <a href="/student.html" class="btn btn-outline-secondary btn-sm me-2">Back</a>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div id="profCard" class="card mx-auto" style="max-width:900px;"></div>
  </main>
  <script>
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/'; }
    try { const payload = JSON.parse(atob(token.split('.')[1])); document.getElementById('welcome').innerText = `Hello ${payload.sub || payload.email}`; } catch(e) { document.getElementById('welcome').innerText = '' }

    async function loadProf() {
      const params = new URLSearchParams(window.location.search);
      const email = params.get('email');
      if (!email) { document.getElementById('profCard').innerText = 'No professor specified'; return; }
      // First try the new profile-service (running on port 8083). If it's not available or returns non-OK,
      // fall back to the existing CRUD endpoint under /admin-api so nothing breaks.
      let res;
      try {
        res = await fetch(`http://localhost:8083/profiles/by-email?email=${encodeURIComponent(email)}`, { headers: { 'Authorization':'Bearer ' + token } });
        if (!res.ok) {
          // fallback to CRUD service
          res = await fetch(`/admin-api/users/by-email?email=${encodeURIComponent(email)}`, { headers: { 'Authorization':'Bearer ' + token } });
        }
      } catch (err) {
        // Network error connecting to profile-service; fallback
        res = await fetch(`/admin-api/users/by-email?email=${encodeURIComponent(email)}`, { headers: { 'Authorization':'Bearer ' + token } });
      }
      if (!res.ok) { let t='Unable to load'; try{ const j = await res.json(); if (j && j.error) t += ': ' + j.error; }catch(e){} document.getElementById('profCard').innerText = t; return; }
      const j = await res.json(); const u = j.user || {};
      const rows = [ ['Name', u.name || ''], ['Email', u.email || ''], ['Department', u.department || ''], ['Designation', u.designation || ''], ['Room', u.room || u.roomNumber || ''], ['Staff ID', u.staffId || ''], ['Location', u.location || 'Not Added'] ];
      // build tbody so we can inject a Google Calendar button next to Location when present
      let tbodyHtml = '';
      rows.forEach(r => {
        if (r[0] === 'Location') {
          const locVal = (u.location == null || u.location === '') ? 'Not Added' : u.location;
          if (u.location != null && String(u.location).trim() !== '') {
            // scope maps search to NITK Surathkal
            const mapsQuery = `${u.location}, NITK Surathkal`;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapsQuery)}`;
            tbodyHtml += `<tr><th style="width:160px">${r[0]}</th><td>${locVal} <a target="_blank" rel="noopener noreferrer" href="${mapsUrl}" class="btn btn-sm btn-outline-success ms-2">Open in Google Maps</a></td></tr>`;
          } else {
            tbodyHtml += `<tr><th style="width:160px">${r[0]}</th><td>${locVal}</td></tr>`;
          }
        } else {
          tbodyHtml += `<tr><th style="width:160px">${r[0]}</th><td>${r[1]}</td></tr>`;
        }
      });
      const table = `<div class="card-body"><table class="table table-sm"><tbody>${tbodyHtml}</tbody></table>`;
      const emailParam = encodeURIComponent(u.email || '');
      const buttons = `<div class="px-3 pb-3">
          <a href="/calendar.html?email=${emailParam}" class="btn btn-sm btn-outline-primary me-2">Open Calendar</a>
          <a href="/book-meeting.html?email=${emailParam}" class="btn btn-sm btn-primary">Book Meetings</a>
        </div></div>`;
      document.getElementById('profCard').innerHTML = table + buttons;
    }
    loadProf();
  </script>
</body>
</html>