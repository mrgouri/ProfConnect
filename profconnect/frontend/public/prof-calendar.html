<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProfConnect Calendar</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .calendar-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 30px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .controls h2 {
      font-weight: 600;
      color: #333;
    }

    .btn {
      border-radius: 8px;
    }

    .spinner-border {
      width: 2rem;
      height: 2rem;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 250px;
    }
  </style>
</head>
<body>
  <div class="calendar-container">
    <div class="controls">
      <h2>My Calendar</h2>
      <div>
        <button id="refreshEvents" class="btn btn-primary me-2">
          Refresh Events
        </button>
        <button id="viewGoogle" class="btn btn-outline-secondary">
          Open in Google Calendar
        </button>
      </div>
    </div>

    <div id="calendar"></div>
    <div id="loading" class="loading d-none">
      <div class="spinner-border text-primary" role="status"></div>
      <span class="ms-2 text-secondary">Loading events...</span>
    </div>

    <div id="eventList" class="mt-4"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const email = params.get("email") || localStorage.getItem("userEmail");
      
    const calendarApiBase = "http://localhost:8084/calendar-api";
    let calendar;

    async function initCalendar() {
      if (!email) {
        alert("No email found in localStorage. Please sign in again.");
        return;
      }

      document.getElementById("loading").classList.remove("d-none");

      try {
        const res = await fetch(`${calendarApiBase}/events?email=${email}`);
        const events = await res.json();
        console.log("âœ… Events fetched:", events);

        document.getElementById("loading").classList.add("d-none");

        const allEvents = normalizeEvents(events);
        const upcomingEvents = filterUpcomingEvents(allEvents);

        // Show all events in calendar
        renderCalendar(allEvents);

        // Show only upcoming in the list
        renderTextList(upcomingEvents);
      } catch (err) {
        console.error("Error fetching events:", err);
        alert("Failed to fetch events. Please try again.");
        document.getElementById("loading").classList.add("d-none");
      }
    }

    // âœ… Normalize events for both calendar and list
    function normalizeEvents(eventsData) {
      return (eventsData || []).map(ev => {
        const hasDateTime = !!(ev.start?.dateTime || ev.end?.dateTime);
        const start = hasDateTime
          ? new Date(ev.start?.dateTime || ev.start)
          : new Date(ev.start?.date || ev.start);
        const end = hasDateTime
          ? new Date(ev.end?.dateTime || ev.end)
          : new Date(ev.end?.date || ev.end);

        return {
          title: ev.summary || ev.title || "No Title",
          start: start,
          end: end,
          allDay: !hasDateTime, // âœ… all-day events for festivals/holidays
          description: ev.description || "",
        };
      });
    }

    // âœ… Filter only future (upcoming) events
    function filterUpcomingEvents(eventsData) {
      const now = new Date();
      return eventsData
        .filter(e => e.start && new Date(e.start) >= now)
        .sort((a, b) => new Date(a.start) - new Date(b.start));
    }

    // âœ… Render all events (both timed & all-day)
    function renderCalendar(eventsData) {
      const calendarEl = document.getElementById("calendar");

      if (calendar) calendar.destroy();

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: "auto",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay",
        },
        slotMinTime: "06:00:00",
        slotMaxTime: "22:00:00",
        events: eventsData,
        eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: true },
        eventClick: function (info) {
          const start = info.event.start
            ? new Date(info.event.start).toLocaleString()
            : "N/A";
          const end = info.event.end
            ? new Date(info.event.end).toLocaleString()
            : "N/A";
          alert(`ðŸ“… ${info.event.title}\nðŸ•’ ${start} - ${end}`);
        },
      });

      setTimeout(() => calendar.render(), 100);
    }

    // âœ… Render text list of upcoming events
    function renderTextList(eventsData) {
      const listDiv = document.getElementById("eventList");
      if (!listDiv) return;

      if (!eventsData || eventsData.length === 0) {
        listDiv.innerHTML = "<p class='text-muted'>No upcoming events.</p>";
        return;
      }

      listDiv.innerHTML = `
        <h5 class="mt-4">ðŸ“‹ Upcoming Events</h5>
        <ul class="list-group">
          ${eventsData
            .map(
              e => `
              <li class="list-group-item">
                <strong>${e.title}</strong>
                <span class="text-muted">
                  (${new Date(e.start).toLocaleString()})
                </span>
              </li>`
            )
            .join("")}
        </ul>
      `;
    }

    document.getElementById("refreshEvents").onclick = initCalendar;
    document.getElementById("viewGoogle").onclick = () =>
      window.open("https://calendar.google.com", "_blank");

    document.addEventListener("DOMContentLoaded", initCalendar);
  </script>
</body>
</html>
