<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfConnect - Calendar & Appointments</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover {
            background: #3182ce;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4299e1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-secondary:hover {
            background: #718096;
        }

        .appointment-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .appointment-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #4299e1;
        }

        .appointment-item.pending {
            border-left-color: #ed8936;
        }

        .appointment-item.confirmed {
            border-left-color: #48bb78;
        }

        .appointment-item.cancelled {
            border-left-color: #f56565;
        }

        .appointment-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .appointment-title {
            font-weight: 600;
            color: #2d3748;
        }

        .appointment-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fed7d7;
            color: #c53030;
        }

        .status-confirmed {
            background: #c6f6d5;
            color: #2f855a;
        }

        .status-cancelled {
            background: #fed7d7;
            color: #c53030;
        }

        .availability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .availability-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .availability-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Calendar & Appointments</h1>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn">üè† Home</a>
                <a href="prof.html" class="nav-btn">üë®‚Äçüè´ Professor View</a>
                <a href="student.html" class="nav-btn">üë®‚Äçüéì Student View</a>
                <button class="nav-btn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <div id="alert-container"></div>

        <!-- Google Calendar Integration -->
        <div class="card">
            <h3>üîó Google Calendar Integration</h3>
            <button class="btn btn-primary" onclick="initGoogleCalendar()">Connect Google Calendar</button>
            <button class="btn btn-secondary" onclick="loadGoogleEvents()">Load Google Events</button>
        </div>

        <!-- Availability Management -->
        <div class="card">
            <h3>‚è∞ Availability Management</h3>
            <div class="form-group">
                <label>Day of Week:</label>
                <select id="availability-day">
                    <option value="MONDAY">Monday</option>
                    <option value="TUESDAY">Tuesday</option>
                    <option value="WEDNESDAY">Wednesday</option>
                    <option value="THURSDAY">Thursday</option>
                    <option value="FRIDAY">Friday</option>
                    <option value="SATURDAY">Saturday</option>
                    <option value="SUNDAY">Sunday</option>
                </select>
            </div>
            <div class="form-group">
                <label>Start Time:</label>
                <input type="time" id="availability-start">
            </div>
            <div class="form-group">
                <label>End Time:</label>
                <input type="time" id="availability-end">
            </div>
            <div class="form-group">
                <label>Location:</label>
                <input type="text" id="availability-location" placeholder="Office, Online, etc.">
            </div>
            <div class="form-group">
                <label>Type:</label>
                <select id="availability-type">
                    <option value="OFFICE_HOURS">Office Hours</option>
                    <option value="CONSULTATION">Consultation</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="addAvailability()">Add Availability</button>
            <button class="btn btn-secondary" onclick="loadAvailability()">Load My Availability</button>
        </div>

        <!-- Appointment Booking -->
        <div class="card">
            <h3>üìù Book Appointment</h3>
            <div class="form-group">
                <label>Professor Email:</label>
                <input type="email" id="appointment-professor" placeholder="professor@university.edu">
            </div>
            <div class="form-group">
                <label>Title:</label>
                <input type="text" id="appointment-title" placeholder="Meeting Title">
            </div>
            <div class="form-group">
                <label>Description:</label>
                <textarea id="appointment-description" placeholder="Meeting description"></textarea>
            </div>
            <div class="form-group">
                <label>Start Time:</label>
                <input type="datetime-local" id="appointment-start">
            </div>
            <div class="form-group">
                <label>End Time:</label>
                <input type="datetime-local" id="appointment-end">
            </div>
            <div class="form-group">
                <label>Location/Meeting Link:</label>
                <input type="text" id="appointment-location" placeholder="Room number or meeting link">
            </div>
            <button class="btn btn-primary" onclick="bookAppointment()">Book Appointment</button>
        </div>

        <!-- My Appointments -->
        <div class="card">
            <h3>üìã My Appointments</h3>
            <button class="btn btn-secondary" onclick="loadMyAppointments()">Refresh</button>
            <div id="appointments-container" class="appointment-list">
                <div class="loading">Loading appointments...</div>
            </div>
        </div>

        <!-- My Availability -->
        <div class="card">
            <h3>üìÖ My Availability Schedule</h3>
            <button class="btn btn-secondary" onclick="loadAvailability()">Refresh</button>
            <div id="availability-container" class="availability-grid">
                <div class="loading">Loading availability...</div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

        // Show alert function
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Initialize Google Calendar
        async function initGoogleCalendar() {
            try {
                const response = await fetch('/calendar-api/auth-url', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    params: new URLSearchParams({ email: currentUser.email })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    window.open(data.url, '_blank');
                    showAlert('Please complete Google Calendar authorization in the popup window.');
                } else {
                    showAlert('Failed to initiate Google Calendar authorization', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error connecting to Google Calendar', 'error');
            }
        }

        // Load Google Events
        async function loadGoogleEvents() {
            try {
                const response = await fetch('/calendar-api/events', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const events = await response.json();
                    console.log('Google Calendar Events:', events);
                    showAlert(`Loaded ${events.length} Google Calendar events`);
                } else {
                    showAlert('Failed to load Google Calendar events', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error loading Google Calendar events', 'error');
            }
        }

        // Add Availability
        async function addAvailability() {
            const availabilityData = {
                dayOfWeek: document.getElementById('availability-day').value,
                startTime: document.getElementById('availability-start').value,
                endTime: document.getElementById('availability-end').value,
                location: document.getElementById('availability-location').value,
                type: document.getElementById('availability-type').value
            };

            try {
                const response = await fetch('/calendar-api/api/availability', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(availabilityData)
                });
                
                if (response.ok) {
                    showAlert('Availability added successfully!');
                    loadAvailability();
                    // Clear form
                    document.getElementById('availability-start').value = '';
                    document.getElementById('availability-end').value = '';
                    document.getElementById('availability-location').value = '';
                } else {
                    const error = await response.json();
                    showAlert(`Error: ${error.message || 'Failed to add availability'}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error adding availability', 'error');
            }
        }

        // Load Availability
        async function loadAvailability() {
            try {
                const response = await fetch('/calendar-api/api/availability', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const container = document.getElementById('availability-container');
                
                if (response.ok) {
                    const availabilities = await response.json();
                    container.innerHTML = '';
                    
                    if (availabilities.length === 0) {
                        container.innerHTML = '<div class="loading">No availability set</div>';
                        return;
                    }
                    
                    availabilities.forEach(availability => {
                        const item = document.createElement('div');
                        item.className = 'availability-item';
                        item.innerHTML = `
                            <h4>${availability.dayOfWeek}</h4>
                            <p><strong>Time:</strong> ${availability.startTime} - ${availability.endTime}</p>
                            <p><strong>Location:</strong> ${availability.location || 'Not specified'}</p>
                            <p><strong>Type:</strong> ${availability.type}</p>
                            <p><strong>Status:</strong> ${availability.active ? 'Active' : 'Inactive'}</p>
                            <button class="btn btn-danger" onclick="toggleAvailability('${availability.id}')">
                                ${availability.active ? 'Deactivate' : 'Activate'}
                            </button>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<div class="loading">Error loading availability</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('availability-container').innerHTML = '<div class="loading">Error loading availability</div>';
            }
        }

        // Toggle Availability
        async function toggleAvailability(id) {
            try {
                const response = await fetch(`/calendar-api/api/availability/${id}/toggle`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showAlert('Availability status updated!');
                    loadAvailability();
                } else {
                    showAlert('Failed to update availability', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error updating availability', 'error');
            }
        }

        // Book Appointment
        async function bookAppointment() {
            const profId = document.getElementById('appointment-professor').value;
            const appointmentData = {
                professorEmail: document.getElementById('appointment-professor').value,
                studentEmail: currentUser.email,
                studentName: currentUser.name || currentUser.email,
                title: document.getElementById('appointment-title').value,
                description: document.getElementById('appointment-description').value,
                startTime: document.getElementById('appointment-start').value,
                endTime: document.getElementById('appointment-end').value,
                location: document.getElementById('appointment-location').value,
                type: 'CONSULTATION'
            };

            try {
                const response = await fetch(`/calendar-api/events?profId=${profId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });
                
                if (response.ok) {
                    showAlert('Appointment booked successfully!');
                    loadMyAppointments();
                } else {
                    showAlert('Failed to book appointment', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error booking appointment', 'error');
            }
        }

        // Load My Appointments
        async function loadMyAppointments() {
            try {
                const response = await fetch('/calendar-api/api/appointments/student', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const container = document.getElementById('appointments-container');
                
                if (response.ok) {
                    const appointments = await response.json();
                    container.innerHTML = '';
                    
                    if (appointments.length === 0) {
                        container.innerHTML = '<div class="loading">No appointments found</div>';
                        return;
                    }
                    
                    appointments.forEach(appointment => {
                        const item = document.createElement('div');
                        item.className = `appointment-item ${appointment.status.toLowerCase()}`;
                        item.innerHTML = `
                            <div class="appointment-header">
                                <span class="appointment-title">${appointment.title}</span>
                                <span class="appointment-status status-${appointment.status.toLowerCase()}">${appointment.status}</span>
                            </div>
                            <p><strong>Professor:</strong> ${appointment.professorEmail}</p>
                            <p><strong>Date:</strong> ${new Date(appointment.startTime).toLocaleString()}</p>
                            <p><strong>Location:</strong> ${appointment.location || 'Not specified'}</p>
                            <p><strong>Description:</strong> ${appointment.description || 'No description'}</p>
                            <button class="btn btn-danger" onclick="cancelAppointment('${appointment.id}')">Cancel</button>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<div class="loading">Error loading appointments</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('appointments-container').innerHTML = '<div class="loading">Error loading appointments</div>';
            }
        }

        // Cancel Appointment
        async function cancelAppointment(id) {
            if (!confirm('Are you sure you want to cancel this appointment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/calendar-api/api/appointments/${id}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showAlert('Appointment cancelled successfully!');
                    loadMyAppointments();
                } else {
                    showAlert('Failed to cancel appointment', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error cancelling appointment', 'error');
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!authToken) {
                window.location.href = 'index.html';
                return;
            }
            
            loadMyAppointments();
            loadAvailability();
        });
    </script>
</body>
</html>
